<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Control de Pagos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bibliotecas para importación/exportación -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com" rel="stylesheet" />
    <style>
      :root {
        --background: #ffffff;
        --foreground: #1f2937;
        --card: #f8fafc;
        --card-foreground: #374151;
        --primary: #3b82f6;
        --primary-foreground: #ffffff;
        --secondary: #10b981;
        --secondary-foreground: #ffffff;
        --muted: #f1f5f9;
        --muted-foreground: #64748b;
        --accent: #8b5cf6;
        --destructive: #ef4444;
        --border: #e2e8f0;
        --input: #ffffff;
        --sidebar: #f8fafc;
      }

      [data-theme="dark"] {
        --background: #0f172a;
        --foreground: #f1f5f9;
        --card: #1e293b;
        --card-foreground: #e2e8f0;
        --primary: #3b82f6;
        --primary-foreground: #ffffff;
        --secondary: #10b981;
        --secondary-foreground: #ffffff;
        --muted: #334155;
        --muted-foreground: #94a3b8;
        --accent: #8b5cf6;
        --destructive: #ef4444;
        --border: #475569;
        --input: #1e293b;
        --sidebar: #1e293b;
      }

      .font-display {
        font-family: "Poppins", sans-serif;
      }
      .font-body {
        font-family: "Inter", sans-serif;
      }

      .bg-background {
        background-color: var(--background);
      }
      .bg-card {
        background-color: var(--card);
      }
      .bg-primary {
        background-color: var(--primary);
      }
      .bg-secondary {
        background-color: var(--secondary);
      }
      .bg-muted {
        background-color: var(--muted);
      }
      .bg-destructive {
        background-color: var(--destructive);
      }

      .text-foreground {
        color: var(--foreground);
      }
      .text-card-foreground {
        color: var(--card-foreground);
      }
      .text-primary-foreground {
        color: var(--primary-foreground);
      }
      .text-secondary-foreground {
        color: var(--secondary-foreground);
      }
      .text-muted-foreground {
        color: var(--muted-foreground);
      }

      .border-border {
        border-color: var(--border);
      }

      .hidden {
        display: none;
      }
      .block {
        display: block;
      }

      .btn {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        /* Making buttons more touch-friendly on mobile */
        min-height: 44px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .btn-primary {
        background-color: var(--primary);
        color: var(--primary-foreground);
      }

      .btn-primary:hover {
        opacity: 0.9;
      }

      .btn-secondary {
        background-color: var(--secondary);
        color: var(--secondary-foreground);
      }

      .btn-secondary:hover {
        opacity: 0.9;
      }

      .btn-accent {
        background-color: var(--accent);
        color: var(--primary-foreground);
      }

      .btn-destructive {
        background-color: var(--destructive);
        color: var(--primary-foreground);
      }

      .btn-destructive:hover {
        opacity: 0.9;
      }

      .theme-toggle {
        background-color: var(--muted);
        color: var(--foreground);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        padding: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
      }

      .theme-toggle:hover {
        background-color: var(--accent);
        color: var(--primary-foreground);
      }

      .card {
        background-color: var(--card);
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border);
      }

      .input {
        background-color: var(--input);
        border: 1px solid var(--border);
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
        width: 100%;
        color: var(--foreground);
        /* Making inputs more touch-friendly */
        min-height: 44px;
        font-size: 16px; /* Prevents zoom on iOS */
      }

      .input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
      }

      .table {
        width: 100%;
        border-collapse: collapse;
      }

      .table th,
      .table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--border);
      }

      .table th {
        background-color: var(--muted);
        font-weight: 600;
        color: var(--foreground);
      }

      .table tr:nth-child(even) {
        background-color: var(--muted);
      }

      .sidebar {
        background-color: var(--sidebar);
        width: 250px;
        height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        border-right: 1px solid var(--border);
        padding: 1rem;
        /* Making sidebar responsive */
        z-index: 1000;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 250px;
        padding: 2rem;
        /* Making main content responsive */
        transition: margin-left 0.3s ease;
      }

      .nav-item {
        padding: 0.75rem 1rem;
        margin: 0.25rem 0;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: background-color 0.2s;
        color: var(--foreground);
      }

      .nav-item:hover {
        background-color: var(--muted);
      }

      .nav-item.active {
        background-color: var(--primary);
        color: var(--primary-foreground);
      }

      .metric-card {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: var(--primary-foreground);
        border-radius: 0.5rem;
        padding: 1.5rem;
        text-align: center;
      }

      .progress-bar {
        background-color: var(--muted-foreground); /* Light gray background */
        border-radius: 0.5rem;
        height: 1.5rem;
        position: relative;
        overflow: hidden;
        width: 100%;
        margin: 0.5rem 0;
      }

      .progress-fill {
        background-color: var(--secondary);
        border-radius: 0.5rem;
        height: 100%;
        width: 0%;
        transition: width 0.5s ease-in-out;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--foreground);
        white-space: nowrap;
      }

      .progress-fill .progress-text {
        color: var(--foreground);
      }

      .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.5);
        /* Fixed modal positioning to account for sidebar */
        z-index: 1000;
      }

      .modal-content {
        background-color: var(--background);
        color: var(--foreground);
        border: 1px solid var(--border);
        /* Improved modal centering considering sidebar */
        position: relative;
        margin: auto;
      }

      /* Added specific modal positioning for desktop with sidebar */
      @media (min-width: 769px) {
        .modal-backdrop {
          padding-left: 250px; /* Account for sidebar width */
        }

        .modal-content {
          margin-left: auto;
          margin-right: auto;
        }
      }

      /* Mobile modal should use full width */
      @media (max-width: 768px) {
        .modal-backdrop {
          padding-left: 0;
        }
      }

      /* Adding mobile hamburger menu */
      .mobile-menu-btn {
        display: none;
        position: fixed;
        top: 1rem;
        left: 1rem;
        z-index: 1001;
        background-color: var(--primary);
        color: var(--primary-foreground);
        border: none;
        border-radius: 0.375rem;
        padding: 0.5rem;
        cursor: pointer;
        width: 44px;
        height: 44px;
        align-items: center;
        justify-content: center;
      }

      /* Adding grid utility classes for responsive layout */
      .grid {
        display: grid;
      }

      .grid-cols-1 {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }

      .gap-6 {
        gap: 1.5rem;
      }

      .gap-3 {
        gap: 0.75rem;
      }

      .flex {
        display: flex;
      }

      .flex-1 {
        flex: 1 1 0%;
      }

      .items-center {
        align-items: center;
      }

      .justify-center {
        justify-content: center;
      }

      .justify-between {
        justify-content: space-between;
      }

      .mb-2 {
        margin-bottom: 0.5rem;
      }
      .mb-4 {
        margin-bottom: 1rem;
      }
      .mb-6 {
        margin-bottom: 1.5rem;
      }
      .mb-8 {
        margin-bottom: 2rem;
      }

      .text-lg {
        font-size: 1.125rem;
      }
      .text-xl {
        font-size: 1.25rem;
      }
      .text-3xl {
        font-size: 1.875rem;
      }
      .text-sm {
        font-size: 0.875rem;
      }

      .font-semibold {
        font-weight: 600;
      }
      .font-bold {
        font-weight: 700;
      }
      .font-medium {
        font-weight: 500;
      }

      .fixed {
        position: fixed;
      }
      .inset-0 {
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }
      .rounded-lg {
        border-radius: 0.5rem;
      }
      .w-96 {
        width: 24rem;
      }
      .p-6 {
        padding: 1.5rem;
      }

      /* Adding responsive table wrapper */
      .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      /* Mobile responsive styles */
      @media (max-width: 768px) {
        .mobile-menu-btn {
          display: flex;
        }

        .sidebar {
          transform: translateX(-100%);
        }

        .main-content {
          margin-left: 0;
          padding: 1rem;
          padding-top: 4rem; /* Space for mobile menu button */
        }

        .grid-cols-1.md\:grid-cols-4 {
          grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        .grid-cols-1.md\:grid-cols-2 {
          grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        .metric-card {
          padding: 1rem;
        }

        .metric-card h3 {
          font-size: 1rem;
        }

        .metric-card p {
          font-size: 1.5rem;
        }

        .card {
          padding: 1rem;
        }

        .table th,
        .table td {
          padding: 0.5rem;
          font-size: 0.875rem;
        }

        .modal-content {
          width: 90vw;
          max-width: 400px;
          margin: 1rem;
          /* Reset margin for mobile */
          margin-left: auto;
          margin-right: auto;
        }

        .btn {
          padding: 0.75rem 1rem;
          font-size: 0.875rem;
        }

        /* Stack buttons vertically on mobile */
        .flex.gap-3 {
          flex-direction: column;
        }

        .flex.gap-3 .btn {
          width: 100%;
        }
      }

      /* Tablet responsive styles */
      @media (min-width: 769px) and (max-width: 1024px) {
        .grid-cols-1.md\:grid-cols-4 {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .grid-cols-1.md\:grid-cols-2 {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      /* Desktop responsive styles */
      @media (min-width: 1025px) {
        .sidebar {
          transform: translateX(0);
        }

        .grid-cols-1.md\:grid-cols-4 {
          grid-template-columns: repeat(4, minmax(0, 1fr));
        }

        .grid-cols-1.md\:grid-cols-2 {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
    </style>
  </head>
  <body class="bg-background text-foreground font-body">
    <!-- Adding mobile menu button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">☰</button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="flex justify-between items-center mb-8">
        <h1 class="font-display text-2xl font-bold text-primary">
          Control de Pagos
        </h1>
        <button
          class="theme-toggle"
          onclick="toggleTheme()"
          title="Cambiar tema"
        >
          <span id="theme-icon">🌙</span>
        </button>
      </div>
      <nav>
        <div class="nav-item active" onclick="showSection('personas')">
          <span>👥 Personas</span>
        </div>
        <div class="nav-item" onclick="showSection('pagos')">
          <span>💰 Pagos</span>
        </div>
        <div class="nav-item" onclick="showSection('reportes')">
          <span>📊 Reportes</span>
        </div>
        <div class="nav-item" onclick="showSection('configuracion')">
          <span>⚙️ Configuración</span>
        </div>
        <div
          class="absolute bottom-4 left-0 right-0 text-center text-sm text-muted-foreground"
        >
          <a
            href="https://github.com/Zendyr24"
            target="_blank"
            class="hover:text-primary transition-colors"
          >
            @Zendyr24
          </a>
        </div>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Sección Personas -->
      <div id="personas-section" class="section">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-semibold font-display">
            Gestión de Personas
          </h2>
          <div class="flex gap-3">
            <button class="btn btn-primary" onclick="openPersonModal()">
              + Agregar Persona
            </button>
          </div>
        </div>
        <div class="mb-4">
          <input
            type="text"
            id="personas-search"
            class="input"
            placeholder="🔍 Buscar persona..."
            onkeyup="filterPersonasTable()"
          />
        </div>
        <div class="card">
          <!-- Adding responsive table wrapper -->
          <div class="table-wrapper">
            <table class="table">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Miembros</th>
                  <th>Monto Total</th>
                  <th>Pagado</th>
                  <th>Pendiente</th>
                  <th>Progreso</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="personas-table">
                <!-- Datos dinámicos -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Sección Pagos -->
      <div id="pagos-section" class="section hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-semibold font-display">Registro de Pagos</h2>
          <button class="btn btn-primary" onclick="openPaymentModal()">
            + Registrar Pago
          </button>
        </div>
        <div class="mb-4">
          <input
            type="text"
            id="pagos-search"
            class="input"
            placeholder="🔍 Buscar pago..."
            onkeyup="filterPagosTable()"
          />
        </div>
        <div class="card">
          <!-- Adding responsive table wrapper -->
          <div class="table-wrapper">
            <table class="table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Persona</th>
                  <th>Monto</th>
                  <th>Moneda</th>
                  <th>Tasa</th>
                  <th>Monto USD</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="pagos-table"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Sección Reportes -->
      <div id="reportes-section" class="section hidden">
        <h2 class="font-display text-3xl font-bold mb-6">
          Reportes y Métricas
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <div class="metric-card">
            <h3 class="text-lg font-semibold mb-2">Total Recaudado</h3>
            <p class="text-3xl font-bold" id="total-recaudado">$0.00</p>
          </div>
          <div class="metric-card">
            <h3 class="text-lg font-semibold mb-2">Meta de Referencia</h3>
            <p class="text-3xl font-bold" id="meta-objetivo">$0.00</p>
          </div>
          <div class="metric-card">
            <h3 class="text-lg font-semibold mb-2">Progreso</h3>
            <p class="text-3xl font-bold" id="progreso-total">0%</p>
          </div>
          <div class="metric-card">
            <h3 class="text-lg font-semibold mb-2">Estado vs Meta</h3>
            <p class="text-3xl font-bold" id="estado-meta">$0.00</p>
          </div>
        </div>

        <!-- Added currency breakdown section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <div class="card">
            <h3 class="text-xl font-semibold mb-4">Recaudado por Moneda</h3>
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-muted-foreground"
                  >Total en Dólares (USD):</span
                >
                <span class="font-bold text-green-600" id="total-usd"
                  >$0.00</span
                >
              </div>
              <div class="flex justify-between items-center">
                <span class="text-muted-foreground"
                  >Total en Bolívares (VES):</span
                >
                <span class="font-bold text-blue-600" id="total-ves"
                  >Bs. 0.00</span
                >
              </div>
              <div class="border-t border-border pt-2">
                <div class="flex justify-between items-center">
                  <span class="font-medium">Equivalente Total USD:</span>
                  <span class="font-bold text-primary" id="total-equivalent-usd"
                    >$0.00</span
                  >
                </div>
              </div>
            </div>
          </div>
          <div class="card">
            <h3 class="text-xl font-semibold mb-4">Asistencia por Día</h3>
            <div class="space-y-3" id="asistencia-por-dia">
              <!-- Aquí se agregarán dinámicamente los días y asistentes -->
              <p class="text-muted-foreground text-center py-4">
                Cargando datos de asistencia...
              </p>
            </div>
          </div>
        </div>

        <div class="card mb-6">
          <h3 class="text-xl font-semibold mb-4">Progreso General vs Meta</h3>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-bar-fill" style="width: 0%">
              <span class="progress-text" id="progress-bar-text-fill">0%</span>
            </div>
            <span class="progress-text" id="progress-bar-text-bg">0%</span>
          </div>
          <p class="text-sm text-muted-foreground mt-2" id="completion-text">
            0 de 0 personas han completado sus pagos
          </p>
        </div>

        <p class="text-sm font-medium mt-2" id="surplus-text"></p>

        <div class="card">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Importar / Exportar Datos</h3>
            <div class="flex gap-3">
              <input
                type="file"
                id="excel-import"
                accept=".xlsx,.xls"
                style="display: none"
                onchange="importFromExcel(event)"
              />
              <button
                class="btn btn-primary"
                onclick="document.getElementById('excel-import').click()"
              >
                📁 Importar Excel
              </button>
              <button class="btn btn-secondary" onclick="exportToExcel()">
                📊 Exportar a Excel
              </button>
              <!-- Added PDF export button -->
              <button class="btn btn-accent" onclick="exportToPDF()">
                📄 Exportar a PDF
              </button>
            </div>
          </div>
          <div class="text-sm text-muted-foreground">
            <p>
              <strong>Importar:</strong> Selecciona un archivo Excel. El sistema
              buscará coincidencias por ID o Nombre para actualizar, y creará
              personas nuevas si no encuentra coincidencias.
            </p>
            <p>
              <strong>Exportar Excel:</strong> Descarga todos los datos actuales
              en formato Excel para respaldo.
            </p>
            <!-- Added PDF export description -->
            <p>
              <strong>Exportar PDF:</strong> Genera un reporte profesional en
              formato PDF con todos los datos y métricas.
            </p>
          </div>
        </div>
      </div>

      <!-- Sección Configuración -->
      <div id="configuracion-section" class="section hidden">
        <h2 class="font-display text-3xl font-bold mb-6">Configuración</h2>

        <div class="card">
          <form id="config-form">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium mb-2"
                  >Tasa del Dólar (Bs.)</label
                >
                <input
                  type="number"
                  id="tasa-dolar"
                  class="input"
                  step="0.01"
                  placeholder="36.50"
                />
              </div>
              <div>
                <label class="block text-sm font-medium mb-2"
                  >Meta de Referencia (USD)</label
                >
                <input
                  type="number"
                  id="meta-total"
                  class="input"
                  step="0.01"
                  placeholder="1000.00"
                />
                <small class="text-gray-500"
                  >El objetivo para la barra de progreso general.</small
                >
              </div>
              <div>
                <label class="block text-sm font-medium mb-2"
                  >Nombre del Proyecto</label
                >
                <input
                  type="text"
                  id="nombre-proyecto"
                  class="input"
                  placeholder="Proyecto 2024"
                />
              </div>
            </div>

            <!-- Added multi-day event configuration -->
            <div class="mt-6">
              <h3 class="font-medium text-lg mb-4">
                Configuración de Días del Evento
              </h3>
              <div class="space-y-4" id="dias-evento-container">
                <div class="flex gap-4 items-end">
                  <div class="flex-1">
                    <label class="block text-sm font-medium mb-2">Fecha</label>
                    <input type="date" id="nueva-fecha" class="input" />
                  </div>
                  <div class="flex-1">
                    <label class="block text-sm font-medium mb-2"
                      >Precio por Persona (USD)</label
                    >
                    <input
                      type="number"
                      id="nuevo-precio"
                      class="input"
                      step="0.01"
                      placeholder="15.00"
                    />
                  </div>
                  <div class="flex-1">
                    <label class="block text-sm font-medium mb-2"
                      >Descripción</label
                    >
                    <input
                      type="text"
                      id="nueva-descripcion"
                      class="input"
                      placeholder="Día 1 - Conferencias"
                    />
                  </div>
                  <button
                    type="button"
                    onclick="agregarDiaEvento()"
                    class="btn btn-secondary"
                  >
                    Agregar Día
                  </button>
                </div>
              </div>

              <div class="mt-4">
                <h4 class="font-medium mb-2">Días Configurados:</h4>
                <div id="dias-configurados" class="space-y-2">
                  <!-- Días se mostrarán aquí -->
                </div>
              </div>
            </div>

            <div class="mt-6">
              <button type="submit" class="btn btn-primary">
                Guardar Configuración
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal para Registrar Pago -->
    <div
      id="payment-modal"
      class="fixed inset-0 modal-backdrop hidden flex items-center justify-center"
    >
      <div class="modal-content p-6 rounded-lg w-96 mx-4">
        <h3 id="payment-modal-title" class="text-xl font-semibold mb-4">
          Registrar Pago
        </h3>
        <form id="payment-form">
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Persona</label>
            <input
              type="text"
              id="payment-person-search"
              class="input mb-2"
              placeholder="🔍 Buscar persona..."
              onkeyup="filterPaymentPersons()"
            />
            <select id="payment-person" class="input" required>
              <option value="">Seleccionar persona...</option>
            </select>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Monto</label>
            <input
              type="number"
              id="payment-amount"
              class="input"
              step="0.01"
              required
            />
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Moneda</label>
            <select id="payment-currency" class="input" required>
              <option value="USD">Dólares (USD)</option>
              <option value="VES">Bolívares (VES)</option>
            </select>
          </div>
          <div class="flex gap-3">
            <button type="submit" class="btn btn-primary flex-1">
              Guardar
            </button>
            <button
              type="button"
              class="btn btn-destructive"
              onclick="closePaymentModal()"
            >
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para agregar/editar persona -->
    <div
      id="person-modal"
      class="fixed inset-0 modal-backdrop hidden flex items-center justify-center"
      style="display: none"
    >
      <div
        class="modal-content p-6 rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto"
      >
        <h3 id="person-modal-title" class="text-xl font-semibold mb-4">
          Agregar Persona
        </h3>
        <form id="person-form">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium mb-2">Nombre</label>
              <input
                type="text"
                id="person-name"
                class="input"
                required
                placeholder="Nombre de la persona"
              />
            </div>
            <div>
              <label class="block text-sm font-medium mb-2"
                >Número de Miembros</label
              >
              <input
                type="number"
                id="person-members"
                class="input"
                min="1"
                value="1"
                required
                oninput="actualizarVistaAsistencia()"
              />
            </div>
          </div>

          <!-- Contenedor de asistencia siempre visible, se llena dinámicamente -->
          <div id="asistencia-container">
            <!-- Días de asistencia se mostrarán aquí dinámicamente -->
          </div>

          <div class="flex gap-3 mt-4">
            <button type="submit" class="btn btn-primary flex-1">
              Guardar
            </button>
            <button
              type="button"
              class="btn btn-destructive"
              onclick="closePersonModal()"
            >
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("open");
      }

      document.addEventListener("click", function (event) {
        const sidebar = document.getElementById("sidebar");
        const menuBtn = document.querySelector(".mobile-menu-btn");

        if (
          window.innerWidth <= 768 &&
          !sidebar.contains(event.target) &&
          !menuBtn.contains(event.target) &&
          sidebar.classList.contains("open")
        ) {
          sidebar.classList.remove("open");
        }
      });

      // Variables globales
      let personas = JSON.parse(localStorage.getItem("personas") || "[]");
      let pagos = JSON.parse(localStorage.getItem("pagos") || "[]");
      let config = JSON.parse(
        localStorage.getItem("config") ||
          '{"tasaDolar": 36.50, "metaTotal": 1000.00, "nombreProyecto": "Proyecto 2024", "diasEvento": []}'
      );
      let editingPersonId = null;
      let editingPaymentId = null;

      let currentTheme = localStorage.getItem("theme") || "light";

      // --- INICIO: FUNCIONES DE IMPORTACIÓN/EXPORTACIÓN ---

      function exportToExcel() {
        try {
          const nombreProyecto = config.nombreProyecto || "gestor_pagos";
          const nombreArchivo = `${nombreProyecto
            .replace(/[^a-z0-9]/gi, "_")
            .toLowerCase()}_${new Date().toISOString().split("T")[0]}.xlsx`;

          const wb = XLSX.utils.book_new();

          // --- Hoja de Resumen ---
          const totalRecaudado = pagos.reduce(
            (sum, p) => sum + (p.montoUSD || 0),
            0
          );
          const totalComprometido = personas.reduce(
            (sum, p) => sum + calcularMontoTotalPersona(p),
            0
          );
          const metaReferencia = config.metaTotal || 0;
          const progreso =
            metaReferencia > 0 ? (totalRecaudado / metaReferencia) * 100 : 0;
          const resumenData = [
            ["Proyecto", config.nombreProyecto],
            ["Fecha Exportación", new Date().toLocaleDateString()],
            ["Total Recaudado (USD)", totalRecaudado],
            ["Total Comprometido (USD)", totalComprometido],
            ["Meta de Referencia (USD)", metaReferencia],
            ["Progreso vs Meta", progreso / 100],
          ];
          const resumenWS = XLSX.utils.aoa_to_sheet(resumenData);
          resumenWS["B3"].z = "$#,##0.00";
          resumenWS["B4"].z = "$#,##0.00";
          resumenWS["B5"].z = "$#,##0.00";
          resumenWS["B6"].z = "0.00%";
          XLSX.utils.book_append_sheet(wb, resumenWS, "Resumen");

          // --- Hoja de Personas ---
          const personasData = personas.map((p) => {
            const montoTotal = calcularMontoTotalPersona(p);
            const pagado = calcularMontoPagadoPersona(p.id);
            return {
              ID: p.id,
              Nombre: p.nombre,
              Miembros: p.miembros,
              "Monto Total": montoTotal,
              Pagado: pagado,
              Pendiente: montoTotal - pagado,
              AsistenciaPorDia: JSON.stringify(p.asistenciaPorDia || {}),
            };
          });
          const personasWS = XLSX.utils.json_to_sheet(personasData);
          XLSX.utils.book_append_sheet(wb, personasWS, "Personas");

          // --- Hoja de Pagos ---
          const pagosData = pagos.map((p) => ({
            ID: p.id,
            "ID Persona": p.personaId,
            Fecha: p.fecha,
            Monto: p.monto,
            Moneda: p.moneda,
            Tasa: p.tasa,
            "Monto USD": p.montoUSD,
          }));
          const pagosWS = XLSX.utils.json_to_sheet(pagosData);
          XLSX.utils.book_append_sheet(wb, pagosWS, "Pagos");

          // --- Hoja de Configuración ---
          const configData = [
            { key: "nombreProyecto", value: config.nombreProyecto },
            { key: "tasaDolar", value: config.tasaDolar },
            { key: "metaTotal", value: config.metaTotal },
            {
              key: "diasEvento",
              value: JSON.stringify(config.diasEvento || []),
            },
          ];
          const configWS = XLSX.utils.json_to_sheet(configData);
          XLSX.utils.book_append_sheet(wb, configWS, "Configuracion");

          XLSX.writeFile(wb, nombreArchivo);
          alert("Datos exportados exitosamente.");
        } catch (error) {
          console.error("Error al exportar a Excel:", error);
          alert("Ocurrió un error al exportar los datos: " + error.message);
        }
      }

      function importFromExcel(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });

            // Importar Configuración PRIMERO es crucial
            if (workbook.SheetNames.includes("Configuracion")) {
              const configRows = XLSX.utils.sheet_to_json(
                workbook.Sheets["Configuracion"]
              );
              let newConfig = {};
              configRows.forEach((row) => {
                if (row.key === "diasEvento") {
                  newConfig[row.key] = JSON.parse(row.value || "[]");
                } else {
                  newConfig[row.key] = row.value;
                }
              });
              config = newConfig;
            }

            // Lógica de importación inteligente para Personas
            if (workbook.SheetNames.includes("Personas")) {
              const personasRows = XLSX.utils.sheet_to_json(
                workbook.Sheets["Personas"]
              );
              let updatedPersonas = [...personas]; // Copia de las personas actuales

              personasRows.forEach((row) => {
                const importedId = row["ID"] ? String(row["ID"]) : null;
                const importedName = row["Nombre"]
                  ? String(row["Nombre"]).trim()
                  : null;

                if (!importedName) return; // Omitir filas sin nombre

                let existingPersonIndex = -1;

                // 1. Intentar encontrar por ID (más confiable)
                if (importedId) {
                  existingPersonIndex = updatedPersonas.findIndex(
                    (p) => String(p.id) === importedId
                  );
                }

                // 2. Si no se encontró por ID, intentar por nombre (sensible a mayúsculas/minúsculas)
                if (existingPersonIndex === -1) {
                  existingPersonIndex = updatedPersonas.findIndex(
                    (p) => p.nombre.trim() === importedName
                  );
                }

                // Si la persona existe (por ID o nombre), se actualiza. Si no, se crea.
                if (existingPersonIndex !== -1) {
                  // --- ACTUALIZAR PERSONA EXISTENTE ---
                  updatedPersonas[existingPersonIndex].nombre = importedName;
                  updatedPersonas[existingPersonIndex].miembros =
                    Number(row["Miembros"]) ||
                    updatedPersonas[existingPersonIndex].miembros ||
                    1;
                  try {
                    updatedPersonas[existingPersonIndex].asistenciaPorDia =
                      JSON.parse(row["AsistenciaPorDia"] || "{}");
                  } catch {
                    updatedPersonas[existingPersonIndex].asistenciaPorDia =
                      updatedPersonas[existingPersonIndex].asistenciaPorDia ||
                      {};
                  }
                } else {
                  // --- CREAR NUEVA PERSONA ---
                  const newPerson = {
                    id:
                      Date.now().toString() +
                      Math.random().toString(36).substr(2, 9),
                    nombre: importedName,
                    miembros: Number(row["Miembros"]) || 1,
                    asistenciaPorDia: {},
                  };
                  try {
                    newPerson.asistenciaPorDia = JSON.parse(
                      row["AsistenciaPorDia"] || "{}"
                    );
                  } catch {
                    /* se mantiene el objeto vacío por defecto */
                  }
                  updatedPersonas.push(newPerson);
                }
              });
              personas = updatedPersonas; // Reemplazar la lista de personas con la actualizada
            }

            // La importación de pagos se mantiene simple, asumiendo que los IDs de persona son correctos
            if (workbook.SheetNames.includes("Pagos")) {
              pagos = XLSX.utils
                .sheet_to_json(workbook.Sheets["Pagos"])
                .map((row) => ({
                  id: String(row["ID"]),
                  personaId: String(row["ID Persona"]),
                  fecha: row["Fecha"],
                  monto: Number(row["Monto"]),
                  moneda: row["Moneda"],
                  tasa: row["Tasa"] ? Number(row["Tasa"]) : undefined,
                  montoUSD: Number(row["Monto USD"]),
                }));
            }

            // Guardar y refrescar todo
            localStorage.setItem("config", JSON.stringify(config));
            localStorage.setItem("personas", JSON.stringify(personas));
            localStorage.setItem("pagos", JSON.stringify(pagos));

            loadConfig();
            renderPersonas();
            renderPagos();
            updateReportes();
            updatePaymentPersonSelect();

            alert("Datos importados exitosamente.");
          } catch (error) {
            console.error("Error al importar desde Excel:", error);
            alert("Error al importar el archivo: " + error.message);
          } finally {
            event.target.value = "";
          }
        };
        reader.readAsArrayBuffer(file);
      }

      function exportToPDF() {
        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();

          const nombreProyecto = config.nombreProyecto || "Gestor de Pagos";
          const nombreArchivo = `${nombreProyecto
            .replace(/[^a-z0-9]/gi, "_")
            .toLowerCase()}_${new Date().toISOString().split("T")[0]}.pdf`;

          const primaryColor = [41, 128, 185];
          const secondaryColor = [100, 100, 100];

          const addHeader = (title) => {
            doc.setFontSize(16);
            doc.setTextColor(...primaryColor);
            doc.setFont(undefined, "bold");
            doc.text(title, 14, 22);
            doc.setFontSize(10);
            doc.setTextColor(...secondaryColor);
            doc.text(
              `Generado el: ${new Date().toLocaleDateString("es-ES")}`,
              14,
              28
            );
            doc.setDrawColor(...primaryColor);
            doc.line(14, 32, 200, 32);
          };

          // Página de Resumen
          addHeader(`Resumen - ${nombreProyecto}`);

          const totalRecaudado = pagos.reduce(
            (sum, p) => sum + (parseFloat(p.montoUSD) || 0),
            0
          );
          const totalComprometido = personas.reduce(
            (sum, p) => sum + calcularMontoTotalPersona(p),
            0
          );
          const metaReferencia = config.metaTotal || 0;
          const porcentajeCompletado =
            metaReferencia > 0 ? (totalRecaudado / metaReferencia) * 100 : 0;

          let y = 45;
          const addSummaryRow = (label, value) => {
            doc.setFont(undefined, "bold");
            doc.text(label, 14, y);
            doc.setFont(undefined, "normal");
            doc.text(String(value), 70, y);
            y += 8;
          };

          addSummaryRow("Proyecto:", config.nombreProyecto || "N/A");
          addSummaryRow(
            "Total Personas:",
            personas.reduce((sum, p) => sum + p.miembros, 0)
          );
          if (config.diasEvento && config.diasEvento.length > 0) {
            let asistenciaHTML = "";
            config.diasEvento.forEach((dia) => {
              const asistentes = personas.reduce(
                (sum, p) =>
                  sum +
                  ((p.asistenciaPorDia && p.asistenciaPorDia[dia.id]) || 0),
                0
              );
              addSummaryRow(dia.descripcion, asistentes);
            });
          }

          addSummaryRow("Total Recaudado:", `$${totalRecaudado.toFixed(2)}`);
          addSummaryRow("Meta de Referencia:", `$${metaReferencia.toFixed(2)}`);
          addSummaryRow(
            "Progreso vs Meta:",
            `${porcentajeCompletado.toFixed(2)}%`
          );

          // Página de Personas
          doc.addPage();
          addHeader("Lista de Personas");

          const personasData = personas.map((persona) => {
            const montoTotal = calcularMontoTotalPersona(persona);
            const totalPagado = calcularMontoPagadoPersona(persona.id);
            const montoPendiente = montoTotal - totalPagado;
            const progreso =
              montoTotal > 0 ? (totalPagado / montoTotal) * 100 : 0;
            return [
              persona.nombre,
              persona.miembros,
              `$${montoTotal.toFixed(2)}`,
              `$${totalPagado.toFixed(2)}`,
              `$${montoPendiente.toFixed(2)}`,
              `${progreso.toFixed(1)}%`,
            ];
          });

          doc.autoTable({
            startY: 40,
            head: [
              [
                "Nombre",
                "Miembros",
                "Total",
                "Pagado",
                "Pendiente",
                "Progreso",
              ],
            ],
            body: personasData,
            headStyles: { fillColor: primaryColor },
          });

          // Página de Pagos
          doc.addPage();
          addHeader("Registro de Pagos");

          const pagosOrdenados = [...pagos].sort(
            (a, b) => new Date(b.fecha) - new Date(a.fecha)
          );

          const pagosDataPdf = pagosOrdenados.map((p) => {
            const persona = personas.find(
              (per) => String(per.id) === String(p.personaId)
            );
            return [
              p.fecha ? new Date(p.fecha).toLocaleDateString("es-ES") : "N/A",
              persona ? persona.nombre : "Persona eliminada",
              p.monto.toFixed(2),
              p.moneda,
              p.moneda === "VES"
                ? (p.tasa || config.tasaDolar).toFixed(2)
                : "-",
              `$${p.montoUSD.toFixed(2)}`,
            ];
          });

          doc.autoTable({
            startY: 40,
            head: [
              ["Fecha", "Persona", "Monto", "Moneda", "Tasa", "Monto USD"],
            ],
            body: pagosDataPdf,
            headStyles: { fillColor: primaryColor },
          });

          doc.save(nombreArchivo);
        } catch (error) {
          console.error("Error al generar PDF:", error);
          alert("Error al generar el PDF: " + error.message);
        }
      }

      // --- FIN: FUNCIONES DE IMPORTACIÓN/EXPORTACIÓN ---

      // Funciones auxiliares para cálculos
      function calcularMontoTotalPersona(persona) {
        if (!config.diasEvento || config.diasEvento.length === 0) {
          return 0; // Si no hay días configurados, el monto a pagar es 0.
        }
        if (persona.asistenciaPorDia) {
          return config.diasEvento.reduce((sum, dia) => {
            const asistentes = persona.asistenciaPorDia[dia.id] || 0;
            return sum + asistentes * dia.precio;
          }, 0);
        }
        return 0; // Si no tiene datos de asistencia, el total es 0.
      }

      function calcularMontoPagadoPersona(personaId) {
        return pagos
          .filter((p) => String(p.personaId) === String(personaId))
          .reduce((sum, p) => sum + (p.montoUSD || 0), 0);
      }

      // Inicialización
      document.addEventListener("DOMContentLoaded", function () {
        applyTheme(currentTheme);
        loadConfig();
        renderPersonas();
        renderPagos();
        updateReportes();
        updatePaymentPersonSelect();

        document
          .getElementById("person-form")
          .addEventListener("submit", function (e) {
            e.preventDefault();

            const name = document.getElementById("person-name").value.trim();
            const members =
              parseInt(document.getElementById("person-members").value) || 1;

            if (!name) {
              alert("Por favor ingrese el nombre");
              return;
            }

            const asistenciaPorDia = {};
            const diasAsistenciaInputs = document.querySelectorAll(
              '#asistencia-container input[type="number"][data-dia-id]'
            );
            diasAsistenciaInputs.forEach((input) => {
              const diaId = input.dataset.diaId;
              const asistentes = parseInt(input.value, 10) || 0;
              if (asistentes > 0) {
                asistenciaPorDia[diaId] = asistentes;
              }
            });

            if (editingPersonId) {
              const index = personas.findIndex(
                (p) => String(p.id) === String(editingPersonId)
              );
              if (index !== -1) {
                personas[index] = {
                  ...personas[index],
                  nombre: name,
                  miembros: members,
                  asistenciaPorDia,
                };
              }
            } else {
              const newPerson = {
                id: Date.now().toString(),
                nombre: name,
                miembros: members,
                asistenciaPorDia,
              };
              personas.push(newPerson);
            }

            localStorage.setItem("personas", JSON.stringify(personas));
            renderPersonas();
            updateReportes();
            updatePaymentPersonSelect();
            closePersonModal();
          });

        document
          .getElementById("payment-form")
          .addEventListener("submit", function (e) {
            e.preventDefault();

            const personId = document.getElementById("payment-person").value;
            const amount = parseFloat(
              document.getElementById("payment-amount").value
            );
            const currency = document.getElementById("payment-currency").value;

            if (!personId || isNaN(amount) || amount <= 0) {
              alert("Por favor complete todos los campos correctamente");
              return;
            }

            const tasa = currency === "VES" ? config.tasaDolar || 1 : 1;
            const montoUSD = currency === "VES" ? amount / tasa : amount;

            const paymentData = {
              id: editingPaymentId || Date.now().toString(),
              personaId: personId,
              monto: amount,
              moneda: currency,
              tasa: currency === "VES" ? tasa : undefined,
              montoUSD: montoUSD,
              fecha: new Date().toISOString(),
            };

            if (editingPaymentId) {
              const index = pagos.findIndex(
                (p) => String(p.id) === String(editingPaymentId)
              );
              if (index !== -1) {
                paymentData.fecha = pagos[index].fecha; // Conservar fecha original al editar
                pagos[index] = paymentData;
              }
            } else {
              pagos.push(paymentData);
            }

            localStorage.setItem("pagos", JSON.stringify(pagos));
            renderPagos();
            renderPersonas();
            updateReportes();
            closePaymentModal();
          });
      });

      function loadConfig() {
        const savedConfig = localStorage.getItem("config");
        if (savedConfig) {
          config = JSON.parse(savedConfig);
        }
        document.getElementById("tasa-dolar").value = config.tasaDolar;
        document.getElementById("meta-total").value = config.metaTotal;
        document.getElementById("nombre-proyecto").value =
          config.nombreProyecto;
        renderDiasConfigurados();
      }

      document
        .getElementById("config-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          config.tasaDolar =
            parseFloat(document.getElementById("tasa-dolar").value) || 0;
          config.metaTotal =
            parseFloat(document.getElementById("meta-total").value) || 0;
          config.nombreProyecto =
            document.getElementById("nombre-proyecto").value || "";
          localStorage.setItem("config", JSON.stringify(config));
          renderPersonas();
          renderPagos();
          updateReportes();
          alert("Configuración guardada.");
        });

      function toggleTheme() {
        currentTheme = currentTheme === "light" ? "dark" : "light";
        applyTheme(currentTheme);
        localStorage.setItem("theme", currentTheme);
      }

      function applyTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);
        document.getElementById("theme-icon").textContent =
          theme === "light" ? "🌙" : "☀️";
      }

      function showSection(sectionName) {
        document.querySelectorAll(".section").forEach((section) => {
          section.classList.add("hidden");
        });
        document
          .getElementById(sectionName + "-section")
          .classList.remove("hidden");
        document.querySelectorAll(".nav-item").forEach((item) => {
          item.classList.remove("active");
        });
        event.target.closest(".nav-item").classList.add("active");
      }

      function openPersonModal(personId = null) {
        editingPersonId = personId ? String(personId) : null;
        const modal = document.getElementById("person-modal");
        const title = document.getElementById("person-modal-title");
        const form = document.getElementById("person-form");
        form.reset();

        if (editingPersonId) {
          const person = personas.find((p) => String(p.id) === editingPersonId);
          if (person) {
            title.textContent = "Editar Persona";
            document.getElementById("person-name").value = person.nombre;
            document.getElementById("person-members").value = person.miembros;
            renderAsistenciaSection(person);
          }
        } else {
          title.textContent = "Agregar Persona";
          document.getElementById("person-members").value = 1;
          renderAsistenciaSection();
        }
        modal.style.display = "flex";
      }

      function closePersonModal() {
        document.getElementById("person-modal").style.display = "none";
        editingPersonId = null;
        document.getElementById("person-form").reset();
      }

      function agregarDiaEvento() {
        const fecha = document.getElementById("nueva-fecha").value;
        const precio = parseFloat(
          document.getElementById("nuevo-precio").value
        );
        const descripcion = document
          .getElementById("nueva-descripcion")
          .value.trim();

        if (!fecha || isNaN(precio) || precio < 0 || !descripcion) {
          alert("Por favor completa todos los campos del día del evento.");
          return;
        }

        const nuevoDia = {
          id: Date.now(),
          fecha,
          precio,
          descripcion,
        };

        config.diasEvento = config.diasEvento || [];
        config.diasEvento.push(nuevoDia);
        config.diasEvento.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

        localStorage.setItem("config", JSON.stringify(config));
        renderDiasConfigurados();
        document.getElementById("nueva-fecha").value = "";
        document.getElementById("nuevo-precio").value = "";
        document.getElementById("nueva-descripcion").value = "";
      }

      function eliminarDiaEvento(diaId) {
        if (
          confirm(
            "¿Está seguro de eliminar este día? Esto puede afectar los montos totales de las personas."
          )
        ) {
          config.diasEvento = config.diasEvento.filter((d) => d.id !== diaId);
          localStorage.setItem("config", JSON.stringify(config));
          renderDiasConfigurados();
          renderPersonas();
          updateReportes();
        }
      }

      function renderDiasConfigurados() {
        const container = document.getElementById("dias-configurados");
        if (!config.diasEvento || config.diasEvento.length === 0) {
          container.innerHTML = `<p class="text-muted-foreground text-center">No hay días configurados.</p>`;
          return;
        }
        container.innerHTML = config.diasEvento
          .map(
            (dia, index) => `
          <div class="flex items-center justify-between p-2 border rounded-lg bg-muted">
            <div>
              <p class="font-medium">${
                dia.descripcion
              } - <span class="text-secondary font-bold">$${dia.precio.toFixed(
              2
            )}</span></p>
              <p class="text-sm text-muted-foreground">${new Date(
                dia.fecha + "T00:00:00"
              ).toLocaleDateString("es-ES")}</p>
            </div>
            <button type="button" class="btn btn-destructive btn-sm" onclick="eliminarDiaEvento(${
              dia.id
            })">×</button>
          </div>
        `
          )
          .join("");
      }

      function renderAsistenciaSection(persona = null) {
        const container = document.getElementById("asistencia-container");
        if (!config.diasEvento || config.diasEvento.length === 0) {
          container.innerHTML = `<div class="text-center p-4 bg-muted rounded-lg text-muted-foreground">Ve a Configuración para agregar días al evento y poder calcular el monto.</div>`;
          actualizarTotalPersona();
          return;
        }

        const miembros =
          parseInt(document.getElementById("person-members").value) || 1;
        container.innerHTML = `
          <h4 class="font-semibold mb-2">Asistencia por Día</h4>
          <div class="space-y-2">
            ${config.diasEvento
              .map((dia) => {
                const asistentes =
                  persona &&
                  persona.asistenciaPorDia &&
                  persona.asistenciaPorDia[dia.id]
                    ? persona.asistenciaPorDia[dia.id]
                    : 0;
                return `
                <div class="grid grid-cols-3 items-center gap-2 p-2 border rounded-lg">
                  <label for="asistencia-${dia.id}" class="text-sm">${
                  dia.descripcion
                }</label>
                  <input type="number" id="asistencia-${dia.id}" data-dia-id="${
                  dia.id
                }" value="${asistentes}" min="0" max="${miembros}" class="input text-center" oninput="actualizarTotalPersona()">
                  <span class="text-right text-sm text-muted-foreground">$${(
                    asistentes * dia.precio
                  ).toFixed(2)}</span>
                </div>
              `;
              })
              .join("")}
          </div>
          <div id="total-persona" class="mt-4 p-3 bg-primary text-primary-foreground rounded-lg text-center font-bold">
            Total: $0.00
          </div>
        `;
        actualizarTotalPersona();
      }

      function actualizarVistaAsistencia() {
        const miembros =
          parseInt(document.getElementById("person-members").value) || 1;
        document
          .querySelectorAll('#asistencia-container input[type="number"]')
          .forEach((input) => {
            input.max = miembros;
            if (parseInt(input.value) > miembros) {
              input.value = miembros;
            }
          });
        actualizarTotalPersona();
      }

      function actualizarTotalPersona() {
        const totalElement = document.getElementById("total-persona");
        if (!totalElement) return;

        let total = 0;
        config.diasEvento.forEach((dia) => {
          const input = document.getElementById(`asistencia-${dia.id}`);
          if (input) {
            const asistentes = parseInt(input.value) || 0;
            total += asistentes * dia.precio;
            // Actualizar subtotal por día
            const subtotalSpan = input.nextElementSibling;
            if (subtotalSpan)
              subtotalSpan.textContent = `$${(asistentes * dia.precio).toFixed(
                2
              )}`;
          }
        });

        totalElement.textContent = `Total: $${total.toFixed(2)}`;
      }

      function deletePerson(personId) {
        if (
          confirm(
            "¿Está seguro de eliminar esta persona? Todos sus pagos asociados también serán eliminados."
          )
        ) {
          const idStr = String(personId);
          personas = personas.filter((p) => String(p.id) !== idStr);
          pagos = pagos.filter((p) => String(p.personaId) !== idStr);
          localStorage.setItem("personas", JSON.stringify(personas));
          localStorage.setItem("pagos", JSON.stringify(pagos));
          renderPersonas();
          renderPagos();
          updateReportes();
          updatePaymentPersonSelect();
        }
      }

      function renderPersonas() {
        const tbody = document.getElementById("personas-table");
        tbody.innerHTML = "";
        personas.forEach((persona) => {
          const montoTotal = calcularMontoTotalPersona(persona);
          const totalPagado = calcularMontoPagadoPersona(persona.id);
          const progreso =
            montoTotal > 0 ? (totalPagado / montoTotal) * 100 : 0;
          const montoPendiente = montoTotal - totalPagado;
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${persona.nombre}</td>
            <td>${persona.miembros}</td>
            <td>$${montoTotal.toFixed(2)}</td>
            <td>$${totalPagado.toFixed(2)}</td>
            <td class="${
              montoPendiente > 0.01 ? "text-red-600" : "text-green-600"
            }">$${montoPendiente.toFixed(2)}</td>
            <td>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${Math.min(
                  100,
                  progreso
                )}%">
                  <span class="progress-text">${progreso.toFixed(0)}%</span>
                </div>
              </div>
            </td>
            <td>
              <div class="flex gap-2">
                <button class="btn btn-primary text-xs" onclick="openPersonModal('${
                  persona.id
                }')">Editar</button>
                <button class="btn btn-destructive text-xs" onclick="deletePerson('${
                  persona.id
                }')">Eliminar</button>
              </div>
            </td>
          `;
          tbody.appendChild(row);
        });
      }

      function renderPagos() {
        const tbody = document.getElementById("pagos-table");
        tbody.innerHTML = "";
        const sortedPagos = [...pagos].sort(
          (a, b) => new Date(b.fecha) - new Date(a.fecha)
        );
        sortedPagos.forEach((pago) => {
          const persona = personas.find(
            (p) => String(p.id) === String(pago.personaId)
          );
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${new Date(pago.fecha).toLocaleDateString("es-ES")}</td>
            <td>${persona ? persona.nombre : "Persona eliminada"}</td>
            <td>${pago.monto.toFixed(2)}</td>
            <td>${pago.moneda}</td>
            <td>${
              pago.moneda === "VES"
                ? (pago.tasa || config.tasaDolar).toFixed(2)
                : "-"
            }</td>
            <td>$${pago.montoUSD.toFixed(2)}</td>
            <td>
              <div class="flex gap-2">
                  <button class="btn btn-secondary text-xs" onclick="openPaymentModal('${
                    pago.id
                  }')">Editar</button>
                  <button class="btn btn-destructive text-xs" onclick="deletePago('${
                    pago.id
                  }')">Eliminar</button>
              </div>
            </td>
          `;
          tbody.appendChild(row);
        });
      }

      function deletePago(pagoId) {
        if (confirm("¿Está seguro de eliminar este pago?")) {
          pagos = pagos.filter((p) => String(p.id) !== String(pagoId));
          localStorage.setItem("pagos", JSON.stringify(pagos));
          renderPagos();
          renderPersonas();
          updateReportes();
        }
      }

      function updateReportes() {
        // Calcular total recaudado
        const totalRecaudadoDirectoUSD = pagos
          .filter((p) => p.moneda === "USD")
          .reduce((sum, p) => sum + (p.monto || 0), 0);
        const totalRecaudadoVES = pagos
          .filter((p) => p.moneda === "VES")
          .reduce((sum, p) => sum + (p.monto || 0), 0);
        const totalRecaudadoGlobal = pagos.reduce(
          (sum, p) => sum + (p.montoUSD || 0),
          0
        );

        // La meta objetivo es la "Meta de Referencia" de la configuración.
        const metaObjetivo = config.metaTotal || 0;

        const progreso =
          metaObjetivo > 0
            ? Math.min(100, (totalRecaudadoGlobal / metaObjetivo) * 100)
            : 0;
        const diferencia = totalRecaudadoGlobal - metaObjetivo;

        // Contar personas que han completado su pago
        const personasCompletas = personas.filter((p) => {
          const debe = calcularMontoTotalPersona(p);
          return debe === 0 || calcularMontoPagadoPersona(p.id) >= debe - 0.01;
        }).length;

        // Actualizar métricas principales
        document.getElementById(
          "total-recaudado"
        ).textContent = `$${totalRecaudadoGlobal.toFixed(2)}`;
        document.getElementById(
          "meta-objetivo"
        ).textContent = `$${metaObjetivo.toFixed(2)}`;
        document.getElementById(
          "progreso-total"
        ).textContent = `${progreso.toFixed(1)}%`;

        const estadoMetaEl = document.getElementById("estado-meta");
        if (diferencia >= 0) {
          estadoMetaEl.textContent = `+$${diferencia.toFixed(2)}`;
          estadoMetaEl.closest(".metric-card").style.background =
            "linear-gradient(135deg, var(--secondary), #16a34a)";
        } else {
          estadoMetaEl.textContent = `-${Math.abs(diferencia).toFixed(2)}`;
          estadoMetaEl.closest(".metric-card").style.background =
            "linear-gradient(135deg, #f97316, #ef4444)";
        }

        // Actualizar desglose de moneda
        document.getElementById(
          "total-usd"
        ).textContent = `$${totalRecaudadoDirectoUSD.toFixed(2)}`;
        document.getElementById(
          "total-ves"
        ).textContent = `Bs. ${totalRecaudadoVES.toLocaleString("es-ES", {
          minimumFractionDigits: 2,
        })}`;
        document.getElementById(
          "total-equivalent-usd"
        ).textContent = `$${totalRecaudadoGlobal.toFixed(2)}`;

        // Actualizar asistencia por día
        const asistenciaContainer =
          document.getElementById("asistencia-por-dia");
        if (config.diasEvento && config.diasEvento.length > 0) {
          let asistenciaHTML = "";
          config.diasEvento.forEach((dia) => {
            const asistentes = personas.reduce(
              (sum, p) =>
                sum + ((p.asistenciaPorDia && p.asistenciaPorDia[dia.id]) || 0),
              0
            );
            asistenciaHTML += `
                    <div class="flex justify-between items-center">
                        <span class="text-muted-foreground">${dia.descripcion}</span>
                        <span class="font-bold">${asistentes}</span>
                    </div>`;
          });
          asistenciaContainer.innerHTML = asistenciaHTML;
        } else {
          asistenciaContainer.innerHTML =
            '<p class="text-muted-foreground text-center">No hay días de evento configurados.</p>';
        }

        // Actualizar barra de progreso general
        const progressFill = document.getElementById("progress-bar-fill");
        const progressTextFill = document.getElementById(
          "progress-bar-text-fill"
        );
        const progressTextBg = document.getElementById("progress-bar-text-bg");

        progressFill.style.width = `${progreso}%`;
        const progressText = `${progreso.toFixed(1)}%`;
        progressTextFill.textContent = progressText;
        progressTextBg.textContent = progressText;
        progressTextBg.style.visibility = progreso > 50 ? "hidden" : "visible";
        progressTextFill.style.visibility = progreso < 5 ? "hidden" : "visible";

        document.getElementById(
          "completion-text"
        ).textContent = `${personasCompletas} de ${personas.length} personas han completado sus pagos.`;
      }

      function filterPersonasTable() {
        const input = document
          .getElementById("personas-search")
          .value.toUpperCase();
        const rows = document
          .getElementById("personas-table")
          .getElementsByTagName("tr");
        for (let row of rows) {
          const td = row.getElementsByTagName("td")[0];
          if (td) {
            row.style.display =
              (td.textContent || td.innerText).toUpperCase().indexOf(input) > -1
                ? ""
                : "none";
          }
        }
      }

      function filterPagosTable() {
        const input = document
          .getElementById("pagos-search")
          .value.toUpperCase();
        const rows = document
          .getElementById("pagos-table")
          .getElementsByTagName("tr");
        for (let row of rows) {
          const td = row.getElementsByTagName("td")[1];
          if (td) {
            row.style.display =
              (td.textContent || td.innerText).toUpperCase().indexOf(input) > -1
                ? ""
                : "none";
          }
        }
      }

      function filterPaymentPersons() {
        const input = document
          .getElementById("payment-person-search")
          .value.toUpperCase();
        const options = document
          .getElementById("payment-person")
          .getElementsByTagName("option");
        for (let i = 1; i < options.length; i++) {
          options[i].style.display =
            (options[i].textContent || options[i].innerText)
              .toUpperCase()
              .indexOf(input) > -1
              ? ""
              : "none";
        }
      }

      function openPaymentModal(paymentId = null) {
        editingPaymentId = paymentId ? String(paymentId) : null;
        document.getElementById("payment-form").reset();
        const title = document.getElementById("payment-modal-title");
        updatePaymentPersonSelect();

        if (editingPaymentId) {
          const payment = pagos.find((p) => String(p.id) === editingPaymentId);
          if (payment) {
            title.textContent = "Editar Pago";
            document.getElementById("payment-person").value = payment.personaId;
            document.getElementById("payment-amount").value = payment.monto;
            document.getElementById("payment-currency").value = payment.moneda;
          }
        } else {
          title.textContent = "Registrar Pago";
        }

        document.getElementById("payment-modal").classList.remove("hidden");
      }

      function closePaymentModal() {
        document.getElementById("payment-modal").classList.add("hidden");
        editingPaymentId = null;
      }

      function updatePaymentPersonSelect() {
        const select = document.getElementById("payment-person");
        const currentVal = select.value;
        select.innerHTML = '<option value="">Seleccionar persona...</option>';
        personas.forEach((persona) => {
          const option = document.createElement("option");
          option.value = String(persona.id);
          option.textContent = persona.nombre;
          select.appendChild(option);
        });
        select.value = currentVal;
      }
    </script>
  </body>
</html>
